<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××—×•×œ×œ ×›×ª×‘×™ ×ª×‘×™×¢×” - ×“×™× ×™ ×¢×‘×•×“×” | ×œ×•×™×Ÿ ×ª×œ×¨×–</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#1a365d">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="×›×ª×‘×™ ×ª×‘×™×¢×”">
    <link rel="apple-touch-icon" href="/static/icon-192.svg">
    <style>
        :root {
            --primary: #1a365d;
            --primary-light: #2c5282;
            --accent: #c6a04a;
            --bg: #f7f8fa;
            --card: #ffffff;
            --text: #1a202c;
            --text-muted: #718096;
            --border: #e2e8f0;
            --success: #38a169;
            --danger: #e53e3e;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', 'David', Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            direction: rtl;
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 1.5rem 2rem;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
        }

        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 0.3rem;
            letter-spacing: 1px;
        }

        .header .subtitle {
            color: var(--accent);
            font-size: 1rem;
            font-weight: 300;
        }

        .container {
            max-width: 1100px;
            margin: 2rem auto;
            padding: 0 1.5rem;
        }

        .stepper {
            display: flex;
            justify-content: center;
            gap: 0;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .step {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.7rem 1.2rem;
            background: var(--card);
            border: 2px solid var(--border);
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }

        .step:first-child { border-radius: 0 8px 8px 0; }
        .step:last-child { border-radius: 8px 0 0 8px; }

        .step.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .step.completed {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }

        .step-number {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.8rem;
            background: rgba(255,255,255,0.2);
        }

        .step.active .step-number { background: rgba(255,255,255,0.3); }

        .card {
            background: var(--card);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 8px rgba(0,0,0,0.06);
            border: 1px solid var(--border);
        }

        .card h2 {
            color: var(--primary);
            margin-bottom: 1.2rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--accent);
            font-size: 1.3rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .form-group {
            margin-bottom: 0.8rem;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.3rem;
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--primary);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.6rem 0.8rem;
            border: 1.5px solid var(--border);
            border-radius: 8px;
            font-size: 0.95rem;
            direction: rtl;
            transition: border-color 0.2s;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26,54,93,0.1);
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.6rem;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.6rem 0.8rem;
            background: var(--bg);
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
            border: 1.5px solid transparent;
        }

        .checkbox-item:hover { background: #edf2f7; }

        .checkbox-item.checked {
            border-color: var(--primary);
            background: #ebf4ff;
        }

        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--primary);
        }

        .checkbox-item label {
            cursor: pointer;
            font-size: 0.9rem;
        }

        .section-panel {
            display: none;
        }

        .section-panel.active {
            display: block;
        }

        .claim-detail {
            background: var(--bg);
            padding: 1rem;
            border-radius: 8px;
            margin-top: 0.8rem;
            border-right: 3px solid var(--accent);
        }

        .btn-row {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }

        .btn {
            padding: 0.7rem 2rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            font-family: inherit;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }
        .btn-primary:hover { background: var(--primary-light); }

        .btn-success {
            background: var(--success);
            color: white;
        }
        .btn-success:hover { opacity: 0.9; }

        .btn-accent {
            background: var(--accent);
            color: white;
        }
        .btn-accent:hover { opacity: 0.9; }

        .btn-outline {
            background: transparent;
            color: var(--primary);
            border: 2px solid var(--primary);
        }
        .btn-outline:hover { background: var(--primary); color: white; }

        /* Results Panel */
        .results-card {
            background: linear-gradient(135deg, #f6f9fc 0%, #edf2f7 100%);
            border: 2px solid var(--primary);
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }

        .results-table th,
        .results-table td {
            padding: 0.6rem 1rem;
            text-align: right;
            border-bottom: 1px solid var(--border);
        }

        .results-table th {
            background: var(--primary);
            color: white;
            font-weight: 600;
        }

        .results-table tr:hover { background: rgba(26,54,93,0.05); }

        .results-table .total-row {
            font-weight: bold;
            font-size: 1.1rem;
            background: #ebf4ff;
            border-top: 2px solid var(--primary);
        }

        .claim-preview {
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1.5rem;
            max-height: 500px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-size: 0.9rem;
            line-height: 1.8;
            direction: rtl;
            margin-top: 1rem;
        }

        .amount-display {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
            text-align: center;
            padding: 1rem;
        }

        .amount-display .currency {
            font-size: 1.2rem;
            color: var(--text-muted);
        }

        .info-box {
            background: #fffff0;
            border: 1px solid #f6e05e;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            font-size: 0.85rem;
            color: #744210;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .loading.active { display: block; }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        @media (max-width: 768px) {
            .form-grid { grid-template-columns: 1fr; }
            .checkbox-group { grid-template-columns: 1fr; }
            .stepper { gap: 0; }
            .step { padding: 0.5rem 0.7rem; font-size: 0.8rem; }
        }

        #install-btn {
            display: none;
            background: var(--accent);
            color: #1a202c;
            border: none;
            padding: 0.45rem 1.2rem;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            font-family: inherit;
            margin-top: 0.6rem;
            transition: background 0.2s, transform 0.1s;
        }
        #install-btn:hover { background: #d4b05c; transform: scale(1.03); }

        /* Step 0 â€” Landing / Upload */
        .step0-buttons {
            display: flex;
            gap: 1.5rem;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 1rem;
        }
        .step0-btn {
            padding: 1.2rem 2.5rem;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            font-family: inherit;
            border: 2px solid transparent;
            transition: all 0.25s;
            min-width: 260px;
            text-align: center;
        }
        .step0-btn-gold {
            background: linear-gradient(135deg, var(--accent), #d4af37);
            color: var(--primary);
        }
        .step0-btn-gold:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(198,160,74,0.4); }
        .step0-btn-outline {
            background: var(--card);
            color: var(--primary);
            border-color: var(--primary);
        }
        .step0-btn-outline:hover { background: var(--primary); color: white; }

        .upload-zone {
            border: 2.5px dashed var(--accent);
            border-radius: 12px;
            padding: 2.5rem 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.25s;
            background: #fffdf5;
            margin-top: 1rem;
        }
        .upload-zone:hover, .upload-zone.dragover {
            border-color: var(--primary);
            background: #ebf4ff;
        }
        .upload-zone .icon { font-size: 2.5rem; margin-bottom: 0.5rem; }
        .upload-zone p { color: var(--text-muted); margin-top: 0.3rem; font-size: 0.9rem; }

        .file-list {
            list-style: none;
            margin-top: 1rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .file-list li {
            background: var(--bg);
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }
        .file-list li .remove-file {
            cursor: pointer;
            color: var(--danger);
            font-weight: bold;
        }

        .extraction-results {
            margin-top: 1.5rem;
        }
        .extraction-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.8rem;
            margin-top: 1rem;
        }
        .extraction-field label {
            display: block;
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 0.2rem;
        }
        .extraction-field input {
            width: 100%;
            padding: 0.5rem 0.7rem;
            border: 1.5px solid var(--border);
            border-radius: 6px;
            font-size: 0.9rem;
            direction: rtl;
            font-family: inherit;
        }
        .extraction-field input:focus {
            outline: none;
            border-color: var(--primary);
        }
        .extraction-field.full-width { grid-column: 1 / -1; }

        @media (max-width: 768px) {
            .step0-buttons { flex-direction: column; align-items: center; }
            .step0-btn { min-width: 220px; }
            .extraction-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div class="header">
    <h1>××—×•×œ×œ ×›×ª×‘×™ ×ª×‘×™×¢×” - ×“×™× ×™ ×¢×‘×•×“×”</h1>
    <div class="subtitle">×œ×•×™×Ÿ ×ª×œ×¨×– - ××©×¨×“ ×¢×•×¨×›×™ ×“×™×Ÿ</div>
    <button id="install-btn" onclick="installApp()">&#128229; ×”×ª×§×Ÿ ××¤×œ×™×§×¦×™×”</button>
</div>

<div class="container">

    <!-- Step 0: Landing â€” Upload or Manual -->
    <div class="section-panel active" id="step0">
        <div class="card" style="text-align: center;">
            <h2 style="border-bottom: none; text-align: center;">×›×™×¦×“ ×ª×¨×¦×• ×œ×”×ª×—×™×œ?</h2>
            <p style="color: var(--text-muted); margin-bottom: 1.5rem;">
                ×ª×•×›×œ×• ×œ×”×¢×œ×•×ª ××¡××›×™× (×ª×œ×•×©×™ ×©×›×¨, ××›×ª×‘ ×¤×™×˜×•×¨×™× ×•×›×“×³) ×œ××™×œ×•×™ ××•×˜×•××˜×™, ××• ×œ××œ× ××ª ×”×˜×•×¤×¡ ×™×“× ×™×ª.
            </p>
            <div class="step0-buttons">
                <button class="step0-btn step0-btn-gold" onclick="showUploadArea()">
                    ×”×¢×œ××ª ××¡××›×™ ×œ×§×•×— â€” ××™×œ×•×™ ××•×˜×•××˜×™
                </button>
                <button class="step0-btn step0-btn-outline" onclick="skipToManual()">
                    ××™×œ×•×™ ×™×“× ×™
                </button>
            </div>

            <!-- Upload area (hidden initially) -->
            <div id="upload-area" style="display:none; margin-top: 1.5rem; text-align: right;">
                <div class="upload-zone" id="upload-zone"
                     onclick="document.getElementById('file-input').click()">
                    <div class="icon">ğŸ“„</div>
                    <strong>×’×¨×¨×• ×§×‘×¦×™× ×œ×›××Ÿ ××• ×œ×—×¦×• ×œ×‘×—×™×¨×”</strong>
                    <p>×ª××•× ×•×ª (JPG, PNG) ××• PDF â€” ×¢×“ 5 ×§×‘×¦×™×</p>
                </div>
                <input type="file" id="file-input" multiple accept="image/*,.pdf" style="display:none"
                       onchange="handleFiles(this.files)">
                <ul class="file-list" id="file-list"></ul>

                <div class="btn-row" id="analyze-btn-row" style="display:none;">
                    <button class="btn btn-accent" onclick="analyzeDocuments()">×©×œ×— ×œ× ×™×ª×•×—</button>
                </div>

                <div class="loading" id="upload-loading">
                    <div class="spinner"></div>
                    <p>×× ×ª×— ××¡××›×™×...</p>
                </div>

                <!-- Extraction results (hidden initially) -->
                <div class="extraction-results" id="extraction-results" style="display:none;">
                    <h3 style="color: var(--primary); margin-bottom: 0.3rem;">× ×ª×•× ×™× ×©×—×•×œ×¦×• ××”××¡××›×™×</h3>
                    <p style="font-size: 0.85rem; color: var(--text-muted);">× ×™×ª×Ÿ ×œ×¢×¨×•×š ×œ×¤× ×™ ×”××©×š.</p>
                    <div class="extraction-grid">
                        <div class="extraction-field">
                            <label>×©× ×”×¢×•×‘×“/×ª</label>
                            <input type="text" id="ext_employee_name">
                        </div>
                        <div class="extraction-field">
                            <label>×ª.×–.</label>
                            <input type="text" id="ext_id_number">
                        </div>
                        <div class="extraction-field">
                            <label>×©× ×”××¢×¡×™×§</label>
                            <input type="text" id="ext_employer_name">
                        </div>
                        <div class="extraction-field">
                            <label>×—.×¤. / ×¢.×. ××¢×¡×™×§</label>
                            <input type="text" id="ext_employer_id">
                        </div>
                        <div class="extraction-field">
                            <label>×ª××¨×™×š ×ª×—×™×œ×ª ×¢×‘×•×“×”</label>
                            <input type="date" id="ext_start_date">
                        </div>
                        <div class="extraction-field">
                            <label>×ª××¨×™×š ×¡×™×•× ×¢×‘×•×“×”</label>
                            <input type="date" id="ext_end_date">
                        </div>
                        <div class="extraction-field">
                            <label>×©×›×¨ ×—×•×“×©×™ ×‘×¨×•×˜×• (â‚ª)</label>
                            <input type="number" id="ext_monthly_salary">
                        </div>
                        <div class="extraction-field">
                            <label>×ª×¤×§×™×“</label>
                            <input type="text" id="ext_job_title">
                        </div>
                        <div class="extraction-field full-width">
                            <label>×›×ª×•×‘×ª ××’×•×¨×™×</label>
                            <input type="text" id="ext_address">
                        </div>
                        <div class="extraction-field full-width">
                            <label>×¢×•×‘×“×•×ª ××¨×›×–×™×•×ª</label>
                            <textarea id="ext_key_facts" rows="3" style="width:100%; padding:0.5rem 0.7rem; border:1.5px solid var(--border); border-radius:6px; font-size:0.9rem; direction:rtl; font-family:inherit; resize:vertical;"></textarea>
                        </div>
                    </div>
                    <div class="btn-row">
                        <button class="btn btn-success" onclick="confirmExtraction()">××©×¨ ×•×”××©×š</button>
                        <button class="btn btn-outline" onclick="skipToManual()">×“×œ×’ ×•××œ× ×™×“× ×™×ª</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Stepper -->
    <div class="stepper" id="main-stepper" style="display:none;">
        <div class="step" onclick="goToStep(1)" data-step="1">
            <span class="step-number">1</span>
            <span>×¤×¨×˜×™ ×”×¦×“×“×™×</span>
        </div>
        <div class="step" onclick="goToStep(2)" data-step="2">
            <span class="step-number">2</span>
            <span>×ª× ××™ ×”×¢×¡×§×”</span>
        </div>
        <div class="step" onclick="goToStep(3)" data-step="3">
            <span class="step-number">3</span>
            <span>×‘×—×™×¨×ª ×¨×›×™×‘×™×</span>
        </div>
        <div class="step" onclick="goToStep(4)" data-step="4">
            <span class="step-number">4</span>
            <span>×¤×¨×˜×™ ×¨×›×™×‘×™×</span>
        </div>
        <div class="step" onclick="goToStep(5)" data-step="5">
            <span class="step-number">5</span>
            <span>×ª×•×¦××•×ª ×•×›×ª×‘ ×ª×‘×™×¢×”</span>
        </div>
    </div>

    <!-- Step 1: Parties -->
    <div class="section-panel" id="step1">
        <div class="card">
            <h2>×¤×¨×˜×™ ×”×ª×•×‘×¢/×ª</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label>×©× ××œ×</label>
                    <input type="text" id="plaintiff_name" placeholder="×©× ×¤×¨×˜×™ ×•××©×¤×—×”">
                </div>
                <div class="form-group">
                    <label>××¡×¤×¨ ×ª×¢×•×“×ª ×–×”×•×ª</label>
                    <input type="text" id="plaintiff_id" placeholder="××¡×¤×¨ ×ª.×–.">
                </div>
                <div class="form-group">
                    <label>××’×“×¨</label>
                    <select id="gender">
                        <option value="male">×–×›×¨</option>
                        <option value="female">× ×§×‘×”</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>×©× ×ª ×œ×™×“×”</label>
                    <input type="number" id="birth_year" placeholder="×œ××©×œ: 1985">
                </div>
                <div class="form-group full-width">
                    <label>×›×ª×•×‘×ª ××’×•×¨×™×</label>
                    <input type="text" id="plaintiff_address" placeholder="×œ××©×œ: ×”×¨×¦×œ 10, ×ª×œ ××‘×™×‘">
                </div>
            </div>
        </div>

        <div class="card">
            <h2>×¤×¨×˜×™ ×”× ×ª×‘×¢/×ª (×”××¢×¡×™×§)</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label>×©× ×”× ×ª×‘×¢/×”×—×‘×¨×”</label>
                    <input type="text" id="defendant_name" placeholder="×©× ×”×—×‘×¨×” ××• ×”××¢×¡×™×§">
                </div>
                <div class="form-group">
                    <label>×—.×¤. / ×¢.×.</label>
                    <input type="text" id="defendant_id" placeholder="××¡×¤×¨ ×—×‘×¨×” ××• ×¢×•×¡×§">
                </div>
                <div class="form-group">
                    <label>×¡×•×’ × ×ª×‘×¢</label>
                    <select id="defendant_type">
                        <option value="company">×—×‘×¨×” ×‘×¢"×</option>
                        <option value="authorized_dealer">×¢×•×¡×§ ××•×¨×©×”</option>
                        <option value="individual">××“× ×¤×¨×˜×™</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>×‘×¢×œ×™×/×× ×”×œ</label>
                    <input type="text" id="defendant_owner" placeholder="×©× ×”×‘×¢×œ×™× ××• ×”×× ×”×œ">
                </div>
                <div class="form-group full-width">
                    <label>×ª×™××•×¨ ×¢×¡×§/×¤×¢×™×œ×•×ª</label>
                    <input type="text" id="defendant_business" placeholder="×œ××©×œ: ×™×™×‘×•×, ×©×™×•×•×§ ×•××›×™×¨×” ×©×œ ××•×¦×¨×™ ×¨×™×”×•×˜">
                </div>
                <div class="form-group full-width">
                    <label>×›×ª×•×‘×ª ×”× ×ª×‘×¢/×ª</label>
                    <input type="text" id="defendant_address" placeholder="×œ××©×œ: ×”×›×™×©×•×¨ 23, ××©×§×œ×•×Ÿ">
                </div>
            </div>
        </div>

        <div class="btn-row">
            <button class="btn btn-primary" onclick="goToStep(2)">×”××©×š ×œ×©×œ×‘ ×”×‘×</button>
        </div>
    </div>

    <!-- Step 2: Employment Terms -->
    <div class="section-panel" id="step2">
        <div class="card">
            <h2>×¤×¨×˜×™ ×”×¢×¡×§×”</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label>×ª××¨×™×š ×ª×—×™×œ×ª ×¢×‘×•×“×”</label>
                    <input type="date" id="start_date">
                </div>
                <div class="form-group">
                    <label>×ª××¨×™×š ×¡×™×•× ×¢×‘×•×“×”</label>
                    <input type="date" id="end_date">
                </div>
                <div class="form-group">
                    <label>×ª×¤×§×™×“</label>
                    <input type="text" id="job_title" placeholder="×œ××©×œ: ××™×©/××©×ª ××›×™×¨×•×ª">
                </div>
                <div class="form-group">
                    <label>××•×¤×Ÿ ×¡×™×•× ×”×¢×¡×§×”</label>
                    <select id="termination_type">
                        <option value="fired">×¤×™×˜×•×¨×™×</option>
                        <option value="resigned_justified">×”×ª×¤×˜×¨×•×ª ×‘×“×™×Ÿ ××¤×•×˜×¨ (×”×¨×¢×ª ×ª× ××™×)</option>
                        <option value="resigned">×”×ª×¤×˜×¨×•×ª ×¨×’×™×œ×”</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>×™××™ ×¢×‘×•×“×” ×‘×©×‘×•×¢</label>
                    <select id="work_days_per_week">
                        <option value="6">6 ×™××™×</option>
                        <option value="5">5 ×™××™×</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>×©×¢×•×ª ×¢×‘×•×“×” ×‘×™×•× (×××•×¦×¢)</label>
                    <input type="number" step="0.5" id="hours_per_day" value="9" placeholder="9">
                </div>
            </div>
        </div>

        <div class="card">
            <h2>×©×›×¨ ×•×ª× ××™× ×›×¡×¤×™×™×</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label>×©×›×¨ ×‘×¡×™×¡ ×—×•×“×©×™ ×‘×¨×•×˜×• (â‚ª)</label>
                    <input type="number" id="base_salary" placeholder="×œ××©×œ: 6370">
                </div>
                <div class="form-group">
                    <label>×¢××œ×•×ª/×ª×•×¡×¤×•×ª ×—×•×“×©×™×•×ª ×××•×¦×¢×•×ª (â‚ª)</label>
                    <input type="number" id="commissions" value="0" placeholder="0">
                </div>
            </div>

            <div class="form-group full-width" style="margin-top: 1rem;">
                <label>×ª×™××•×¨ ××ª×›×•× ×ª ×¢×‘×•×“×” (××•×¤×¦×™×•× ×œ×™)</label>
                <input type="text" id="work_schedule" placeholder="×œ××©×œ: ×‘×”×ª×× ×œ×¦×¨×›×™ ×”× ×ª×‘×¢×ª ×¢×œ ×¤× ×™ ×©×™×©×” ×™××™× ×‘×©×‘×•×¢, ×‘×™××™× ×'-×”' ×‘×™×Ÿ 10:00-19:00 ×•×‘×™××™ ×•' ×‘×™×Ÿ 09:30-14:00">
            </div>
        </div>

        <div class="btn-row">
            <button class="btn btn-outline" onclick="goToStep(1)">×—×–×¨×”</button>
            <button class="btn btn-primary" onclick="goToStep(3)">×”××©×š ×œ×©×œ×‘ ×”×‘×</button>
        </div>
    </div>

    <!-- Step 3: Claim Components Selection -->
    <div class="section-panel" id="step3">
        <div class="card">
            <h2>×‘×—×™×¨×ª ×¨×›×™×‘×™ ×ª×‘×™×¢×”</h2>
            <p style="color: var(--text-muted); margin-bottom: 1rem;">×¡×× ×• ××ª ×¨×›×™×‘×™ ×”×ª×‘×™×¢×” ×”×¨×œ×•×•× ×˜×™×™× ×œ××§×¨×”:</p>

            <div class="checkbox-group">
                <div class="checkbox-item" onclick="toggleCheck(this)">
                    <input type="checkbox" id="claim_severance" checked>
                    <label for="claim_severance">×¤×™×¦×•×™×™ ×¤×™×˜×•×¨×™×</label>
                </div>
                <div class="checkbox-item" onclick="toggleCheck(this)">
                    <input type="checkbox" id="claim_prior_notice">
                    <label for="claim_prior_notice">×—×œ×£ ×”×•×“×¢×” ××•×§×“××ª</label>
                </div>
                <div class="checkbox-item checked" onclick="toggleCheck(this)">
                    <input type="checkbox" id="claim_unpaid_salary">
                    <label for="claim_unpaid_salary">×©×›×¨ ×©×œ× ×©×•×œ×</label>
                </div>
                <div class="checkbox-item" onclick="toggleCheck(this)">
                    <input type="checkbox" id="claim_overtime">
                    <label for="claim_overtime">×©×¢×•×ª × ×•×¡×¤×•×ª</label>
                </div>
                <div class="checkbox-item" onclick="toggleCheck(this)">
                    <input type="checkbox" id="claim_pension">
                    <label for="claim_pension">×”×¤×¨×©×™ ×”×¤×¨×©×•×ª ×œ×¤× ×¡×™×”</label>
                </div>
                <div class="checkbox-item" onclick="toggleCheck(this)">
                    <input type="checkbox" id="claim_vacation">
                    <label for="claim_vacation">×—×•×¤×©×” ×•×¤×“×™×•×Ÿ ×—×•×¤×©×”</label>
                </div>
                <div class="checkbox-item" onclick="toggleCheck(this)">
                    <input type="checkbox" id="claim_holidays">
                    <label for="claim_holidays">×“××™ ×—×’×™×</label>
                </div>
                <div class="checkbox-item" onclick="toggleCheck(this)">
                    <input type="checkbox" id="claim_recuperation">
                    <label for="claim_recuperation">×“××™ ×”×‘×¨××”</label>
                </div>
                <div class="checkbox-item" onclick="toggleCheck(this)">
                    <input type="checkbox" id="claim_salary_delay">
                    <label for="claim_salary_delay">×¤×™×¦×•×™×™ ×”×œ× ×ª ×©×›×¨</label>
                </div>
                <div class="checkbox-item" onclick="toggleCheck(this)">
                    <input type="checkbox" id="claim_emotional">
                    <label for="claim_emotional">×¢×•×’××ª × ×¤×©</label>
                </div>
                <div class="checkbox-item" onclick="toggleCheck(this)">
                    <input type="checkbox" id="claim_deductions">
                    <label for="claim_deductions">× ×™×›×•×™×™× ×©×œ× ×›×“×™×Ÿ</label>
                </div>
                <div class="checkbox-item" onclick="toggleCheck(this)">
                    <input type="checkbox" id="claim_documents">
                    <label for="claim_documents">××¡×™×¨×ª ××¡××›×™ ×’××¨ ×—×©×‘×•×Ÿ (×˜×•×¤×¡ 161)</label>
                </div>
            </div>
        </div>

        <div class="btn-row">
            <button class="btn btn-outline" onclick="goToStep(2)">×—×–×¨×”</button>
            <button class="btn btn-primary" onclick="goToStep(4)">×”××©×š ×œ×¤×¨×˜×™ ×¨×›×™×‘×™×</button>
        </div>
    </div>

    <!-- Step 4: Claim Details -->
    <div class="section-panel" id="step4">

        <div class="card" id="detail_severance" style="display:none">
            <h2>×¤×™×¦×•×™×™ ×¤×™×˜×•×¨×™×</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label>×¡×›×•× ×¤×™×¦×•×™×™× ×©× ×¦×‘×¨ ×‘×§×•×¤×” (â‚ª)</label>
                    <input type="number" id="severance_deposited" value="0" placeholder="0">
                </div>
            </div>
        </div>

        <div class="card" id="detail_prior_notice" style="display:none">
            <h2>×—×œ×£ ×”×•×“×¢×” ××•×§×“××ª</h2>
            <div class="info-box">
                ×—×œ×£ ×”×•×“×¢×” ××•×§×“××ª ××—×•×©×‘ ××•×˜×•××˜×™×ª ×œ×¤×™ ×—×•×§ ×”×•×“×¢×” ××•×§×“××ª ×œ×¤×™×˜×•×¨×™×Ÿ ×•×œ×”×ª×¤×˜×¨×•×ª, ×ª×©×¡"×-2001:
                ×—×•×“×©×™× 1-6: ×™×•× ×œ×›×œ ×—×•×“×© ×¢×‘×•×“×” | ×—×•×“×©×™× 7-12: 6 ×™××™× + 2.5 ×™××™× ×œ×›×œ ×—×•×“×© ××¢×‘×¨ ×œ-6 | ×©× ×” 2+: 30 ×™××™× (×—×•×“×© ××œ×).
            </div>
        </div>

        <div class="card" id="detail_unpaid_salary" style="display:none">
            <h2>×©×›×¨ ×©×œ× ×©×•×œ×</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label>×¡×›×•× ×©×›×¨ ×©×œ× ×©×•×œ× (â‚ª)</label>
                    <input type="number" id="unpaid_salary_amount" value="0">
                </div>
            </div>
        </div>

        <div class="card" id="detail_overtime" style="display:none">
            <h2>×©×¢×•×ª × ×•×¡×¤×•×ª</h2>
            <div class="info-box">
                ×©×¢×•×ª × ×•×¡×¤×•×ª ××—×•×©×‘×•×ª ×œ×¤×™ 25% ×¢×‘×•×¨ 2 ×”×©×¢×•×ª ×”× ×•×¡×¤×•×ª ×”×¨××©×•× ×•×ª ×•-50% ××¢×‘×¨ ×œ×›×š, ×¢×œ ×‘×¡×™×¡ ×©×‘×•×¢×™.
            </div>
            <div class="form-grid">
                <div class="form-group">
                    <label>×©×¢×•×ª × ×•×¡×¤×•×ª ×©×‘×•×¢×™×•×ª (×ª×¢×¨×™×£ 125%)</label>
                    <input type="number" step="0.5" id="weekly_overtime_125" value="0">
                </div>
                <div class="form-group">
                    <label>×©×¢×•×ª × ×•×¡×¤×•×ª ×©×‘×•×¢×™×•×ª (×ª×¢×¨×™×£ 150%)</label>
                    <input type="number" step="0.5" id="weekly_overtime_150" value="0">
                </div>
            </div>

            <div class="global-ot-toggle" style="margin-top: 1rem;">
                <div style="display:flex; align-items:center; gap:0.5rem; cursor:pointer; color:var(--primary); font-weight:600; font-size:0.95rem;" onclick="toggleGlobalOT()">
                    <span id="global_ot_arrow">â—€</span>
                    <span>×©×›×¨ ×©×¢×ª×™ ×•×©×¢×•×ª × ×•×¡×¤×•×ª ×’×œ×•×‘×œ×™×•×ª (××•×¤×¦×™×•× ×œ×™)</span>
                </div>
                <div id="global_ot_section" style="display:none; margin-top:0.8rem;">
                    <div class="info-box">
                        ×× ×œ×¢×•×‘×“/×ª ×©×•×œ××• ×©×¢×•×ª × ×•×¡×¤×•×ª ×’×œ×•×‘×œ×™×•×ª, ××œ××• ××ª ×”×©×“×•×ª ×”×‘××™×.<br>
                        ×”××¢×¨×›×ª ×ª×—×©×‘ ××ª ×”×”×¤×¨×© ×‘×™×Ÿ ×”×¡×›×•× ×©×©×•×œ× ×‘×¤×•×¢×œ ×œ×‘×™×Ÿ ××” ×©×”×™×” ×¦×¨×™×š ×œ×”×ª×§×‘×œ ×¢×œ ×¤×™ ×—×•×§.
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>×©×›×¨ ×©×¢×ª×™ (â‚ª)</label>
                            <input type="number" step="0.01" id="hourly_wage" value="" placeholder="×©×›×¨ ×©×¢×ª×™ ×‘×¡×™×¡×™">
                        </div>
                        <div class="form-group">
                            <label>×©×¢×•×ª ×¢×‘×•×“×” ×¡×˜× ×“×¨×˜×™×•×ª ×‘×™×•×</label>
                            <input type="number" step="0.5" id="standard_daily_hours" value="8" placeholder="8">
                        </div>
                        <div class="form-group">
                            <label>×©×¢×•×ª ×¢×‘×•×“×” ×‘×¤×•×¢×œ ×‘×™×•× (×××•×¦×¢)</label>
                            <input type="number" step="0.5" id="actual_daily_hours" value="" placeholder="×œ××©×œ: 10.5">
                        </div>
                        <div class="form-group">
                            <label>×©×¢×•×ª × ×•×¡×¤×•×ª ×’×œ×•×‘×œ×™×•×ª ×©×©×•×œ××• ×‘×—×•×“×©</label>
                            <input type="number" step="0.5" id="global_ot_hours" value="" placeholder="××¡×¤×¨ ×©×¢×•×ª × ×•×¡×¤×•×ª ×©×”×•×›×¨×•">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card" id="detail_pension" style="display:none">
            <h2>×”×¤×¨×©×™ ×”×¤×¨×©×•×ª ×œ×¤× ×¡×™×”</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label>×¡×›×•× ×©×”×•×¤×§×“ ×‘×¤×•×¢×œ ×œ×¤× ×¡×™×” (â‚ª)</label>
                    <input type="number" id="pension_deposited" value="0">
                </div>
            </div>
        </div>

        <div class="card" id="detail_vacation" style="display:none">
            <h2>×—×•×¤×©×” ×•×¤×“×™×•×Ÿ ×—×•×¤×©×”</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label>×™××™ ×—×•×¤×©×” ×©×©×•×œ××• ×‘×¤×•×¢×œ</label>
                    <input type="number" step="0.5" id="vacation_days_paid" value="0">
                </div>
                <div class="form-group">
                    <label>×ª×¢×¨×™×£ ×™×•××™ ×©×©×•×œ× (â‚ª)</label>
                    <input type="number" id="vacation_rate_paid" value="0">
                </div>
            </div>
        </div>

        <div class="card" id="detail_holidays" style="display:none">
            <h2>×“××™ ×—×’×™×</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label>×™××™ ×—×’ ×©×©×•×œ××• ×‘×¤×•×¢×œ</label>
                    <input type="number" id="holiday_days_paid" value="0">
                </div>
                <div class="form-group">
                    <label>×ª×¢×¨×™×£ ×™×•××™ ×©×©×•×œ× ×¢×‘×•×¨ ×—×’×™× (â‚ª)</label>
                    <input type="number" id="holiday_rate_paid" value="0">
                </div>
            </div>
        </div>

        <div class="card" id="detail_recuperation" style="display:none">
            <h2>×“××™ ×”×‘×¨××”</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label>×™××™ ×”×‘×¨××” ×©×©×•×œ××• ×‘×¤×•×¢×œ</label>
                    <input type="number" step="0.5" id="recuperation_days_paid" value="0">
                </div>
            </div>
        </div>

        <div class="card" id="detail_salary_delay" style="display:none">
            <h2>×¤×™×¦×•×™×™ ×”×œ× ×ª ×©×›×¨</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label>×¡×›×•× ×¤×™×¦×•×™×™ ×”×œ× ×” (â‚ª)</label>
                    <input type="number" id="salary_delay_amount" value="0">
                </div>
            </div>
        </div>

        <div class="card" id="detail_emotional" style="display:none">
            <h2>×¢×•×’××ª × ×¤×©</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label>×¡×›×•× ×¤×™×¦×•×™ ××‘×•×§×© (â‚ª)</label>
                    <input type="number" id="emotional_amount" value="25000">
                </div>
            </div>
        </div>

        <div class="card" id="detail_deductions" style="display:none">
            <h2>× ×™×›×•×™×™× ×©×œ× ×›×“×™×Ÿ</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label>×¡×›×•× × ×™×›×•×™×™× ×©×œ× ×›×“×™×Ÿ (â‚ª)</label>
                    <input type="number" id="deduction_amount" value="0">
                </div>
            </div>
        </div>

        <div class="card">
            <h2>×¨×§×¢ ×¢×•×‘×“×ª×™ × ×•×¡×£ (××•×¤×¦×™×•× ×œ×™)</h2>
            <div class="form-group">
                <label>×ª×™××•×¨ × ×¨×˜×™×‘×™ ×©×œ ×”× ×¡×™×‘×•×ª</label>
                <textarea id="narrative" rows="6" placeholder="×ª××¨×• ××ª ×”× ×¡×™×‘×•×ª ×”×¨×œ×•×•× ×˜×™×•×ª: ×”×¨×¢×ª ×ª× ××™×, ×”×ª× ×”×’×•×ª ×”××¢×¡×™×§, ××™×¨×•×¢×™× ××¨×›×–×™×™× ×•×›×•'. ×˜×§×¡×˜ ×–×” ×™×©×•×œ×‘ ×‘×’×•×£ ×›×ª×‘ ×”×ª×‘×™×¢×”."></textarea>
            </div>
        </div>

        <div class="card">
            <h2>×¤×¨×˜×™ ×‘×™×ª ×”×“×™×Ÿ ×•×‘× ×›×•×—</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label>×‘×™×ª ×“×™×Ÿ</label>
                    <input type="text" id="court_header" value="×‘×™×ª ×”×“×™×Ÿ ×”××–×•×¨×™ ×œ×¢×‘×•×“×” ×‘×ª×œ ××‘×™×‘">
                </div>
                <div class="form-group">
                    <label>×©× ×¢×•×¨×š/×ª ×”×“×™×Ÿ</label>
                    <input type="text" id="attorney_name" value="×“×•×¨×•×Ÿ ×œ×•×™×Ÿ ×•/××• ××•×”×“ ×ª×œ×¨×–">
                </div>
                <div class="form-group">
                    <label>××¡×¤×¨ ×¨×™×©×™×•×Ÿ (×.×¨.)</label>
                    <input type="text" id="attorney_id" placeholder="×œ××©×œ: 87732">
                </div>
                <div class="form-group full-width">
                    <label>×©× ×”××©×¨×“</label>
                    <input type="text" id="firm_name" value='×œ×•×™×Ÿ ×ª×œ×¨×–, ××©×¨×“ ×¢×•×¨×›×™ ×“×™×Ÿ'>
                </div>
                <div class="form-group full-width">
                    <label>×›×ª×•×‘×ª ×”××©×¨×“</label>
                    <input type="text" id="firm_address" value="××¨×—' ×”××¨×‘×¢×” 28, ×ª×œ ××‘×™×‘, ××’×“×œ×™ ×”××¨×‘×¢×” - ××’×“×œ ×“×¨×•××™, ×§×•××” 19">
                </div>
                <div class="form-group">
                    <label>×˜×œ×¤×•×Ÿ</label>
                    <input type="text" id="firm_phone" value="054-3699782">
                </div>
                <div class="form-group">
                    <label>×¤×§×¡</label>
                    <input type="text" id="firm_fax" value="076-5102966">
                </div>
                <div class="form-group">
                    <label>×“×•×"×œ</label>
                    <input type="text" id="firm_email" value="law@levin-telraz.co.il">
                </div>
            </div>
        </div>

        <div class="card" style="border: 2px solid var(--accent); background: #fffdf5;">
            <h2 style="color: var(--primary);">×™×¦×™×¨×ª ×›×ª×‘ ×ª×‘×™×¢×” ×‘×××¦×¢×•×ª AI</h2>
            <p style="color: var(--text-muted); margin-bottom: 1rem;">
                ×”×–×™× ×• ××ª ×”×¢×•×‘×“×•×ª ×”×’×•×œ××™×•×ª ×©×œ ×”×ª×™×§ â€“ Claude AI ×™× ×ª×— ××ª ×”××™×“×¢ ×•×™×™×¦×¨ ×›×ª×‘ ×ª×‘×™×¢×” ××œ× ×•××•×‘× ×” ×›×•×œ×œ ×¡×¢×™×¤×™×, × ×¡×¤×—×™×, ×ª×—×©×™×‘×™× ×•××–×›×•×¨×™ ×—×§×™×§×”.
            </p>
            <div class="form-group">
                <label>×¢×•×‘×“×•×ª ×’×•×œ××™×•×ª ×•×ª×™××•×¨ × ×¡×™×‘×•×ª ×”×ª×™×§</label>
                <textarea id="raw_facts_input" rows="10" style="width:100%; font-size: 0.95rem; padding: 0.8rem; border: 1px solid var(--border); border-radius: 8px; direction: rtl;"
                    placeholder="×”×–×™× ×• ×›××Ÿ ××ª ×›×œ ×”×¢×•×‘×“×•×ª ×”×¨×œ×•×•× ×˜×™×•×ª: × ×¡×™×‘×•×ª ×”×”×¢×¡×§×”, ×ª× ××™ ×¢×‘×•×“×”, ×”×ª× ×”×œ×•×ª ×”××¢×¡×™×§, × ×¡×™×‘×•×ª ×”×¤×™×˜×•×¨×™×/×”×”×ª×¤×˜×¨×•×ª, ×”×¤×¨×•×ª ×–×›×•×™×•×ª, ××™×¨×•×¢×™× ××¨×›×–×™×™× ×•×›×•'. ×›×›×œ ×©×ª×¡×¤×§×• ×™×•×ª×¨ ×¤×¨×˜×™×, ×›×ª×‘ ×”×ª×‘×™×¢×” ×™×”×™×” ××§×™×£ ×•××“×•×™×§ ×™×•×ª×¨."></textarea>
            </div>
        </div>

        <div class="btn-row">
            <button class="btn btn-outline" onclick="goToStep(3)">×—×–×¨×”</button>
            <button class="btn btn-success" onclick="generateClaim()">×—×©×‘ ×•×¦×•×¨ ×›×ª×‘ ×ª×‘×™×¢×” (×ª×‘× ×™×ª)</button>
            <button class="btn btn-primary" onclick="generateClaimAI()" style="background: linear-gradient(135deg, var(--accent), #d4af37); border: none; color: var(--primary); font-weight: bold;">×™×¦×™×¨×” ×‘×××¦×¢×•×ª AI</button>
        </div>
    </div>

    <!-- Step 5: Results -->
    <div class="section-panel" id="step5">

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p id="loading-text">××—×©×‘ ×•××™×™×¦×¨ ××ª ×›×ª×‘ ×”×ª×‘×™×¢×”...</p>
            <!-- AI Progress stages (shown only for AI generation) -->
            <div id="ai-progress" style="display:none; max-width: 400px; margin: 1rem auto 0; text-align: right;">
                <div style="background: var(--border); border-radius: 8px; height: 6px; overflow: hidden; margin-bottom: 0.8rem;">
                    <div id="progress-bar" style="background: linear-gradient(90deg, var(--accent), #d4af37); height: 100%; width: 0%; border-radius: 8px; transition: width 0.5s ease;"></div>
                </div>
                <div id="progress-stages" style="font-size: 0.85rem; color: var(--text-muted);">
                    <div class="progress-stage" data-stage="calculating" style="padding: 0.2rem 0;">
                        <span class="stage-icon">â³</span> ××—×©×‘ ×¡×›×•××™×...
                    </div>
                    <div class="progress-stage" data-stage="analyzing" style="padding: 0.2rem 0;">
                        <span class="stage-icon">â³</span> ×× ×ª×— ×¢×•×‘×“×•×ª...
                    </div>
                    <div class="progress-stage" data-stage="drafting" style="padding: 0.2rem 0;">
                        <span class="stage-icon">â³</span> ×× ×¡×— ×¡×¢×™×¤×™×...
                    </div>
                    <div class="progress-stage" data-stage="verifying" style="padding: 0.2rem 0;">
                        <span class="stage-icon">â³</span> ×‘×•×“×§ ×¦×™×˜×•×˜×™× ×•×¡×›×•××™×...
                    </div>
                </div>
                <p id="progress-timer" style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.5rem; text-align: center;"></p>
            </div>
        </div>

        <div id="results" style="display:none">
            <div class="card results-card">
                <h2>×¡×™×›×•× ×—×™×©×•×‘×™×</h2>

                <div id="duration-display" style="text-align:center; margin-bottom:1rem; color: var(--text-muted);"></div>

                <div class="amount-display">
                    <span id="total-amount">0</span> <span class="currency">â‚ª</span>
                    <div style="font-size: 0.9rem; color: var(--text-muted); font-weight: normal;">×¡×”"×› ×¡×›×•× ×”×ª×‘×™×¢×” (×§×¨×Ÿ)</div>
                </div>

                <table class="results-table">
                    <thead>
                        <tr>
                            <th>×¨×›×™×‘</th>
                            <th>×¡×›×•× (â‚ª)</th>
                        </tr>
                    </thead>
                    <tbody id="results-tbody">
                    </tbody>
                </table>
            </div>

            <!-- AI Preview Panel (only shown for AI mode) -->
            <div class="card" id="ai-preview-panel" style="display:none; border: 2px solid var(--accent); background: #fffdf5;">
                <h2 style="color: var(--primary); border-bottom-color: var(--accent);">×ª×¦×•×’×” ××§×“×™××” â€” AI</h2>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                    <!-- Sections list -->
                    <div>
                        <h3 style="color: var(--primary); font-size: 1rem; margin-bottom: 0.5rem;">×¡×¢×™×¤×™× ×©× ×•×¦×¨×•</h3>
                        <ul id="preview-sections" style="list-style: none; padding: 0; font-size: 0.85rem;"></ul>
                    </div>
                    <!-- Appendices -->
                    <div>
                        <h3 style="color: var(--primary); font-size: 1rem; margin-bottom: 0.5rem;">× ×¡×¤×—×™×</h3>
                        <ul id="preview-appendices" style="list-style: none; padding: 0; font-size: 0.85rem;"></ul>
                    </div>
                </div>

                <!-- Claims table with formulas -->
                <h3 style="color: var(--primary); font-size: 1rem; margin: 1rem 0 0.5rem;">×—×™×©×•×‘×™× ×•× ×•×¡×—××•×ª</h3>
                <table class="results-table" style="font-size: 0.85rem;">
                    <thead>
                        <tr>
                            <th>×¨×›×™×‘</th>
                            <th>× ×•×¡×—×”</th>
                            <th>×¡×›×•× (â‚ª)</th>
                        </tr>
                    </thead>
                    <tbody id="preview-claims-tbody"></tbody>
                </table>

                <div id="preview-total" style="text-align: center; font-weight: bold; font-size: 1.1rem; color: var(--primary); margin-top: 0.5rem;"></div>

                <!-- Verification notes -->
                <div id="preview-verification" style="display:none; margin-top: 1rem; padding: 0.7rem; background: #f0f5ff; border-radius: 6px; font-size: 0.8rem;">
                    <strong>×”×¢×¨×•×ª ××™××•×ª:</strong>
                    <ul id="preview-verification-list" style="margin: 0.3rem 0 0; padding-right: 1.2rem;"></ul>
                </div>

                <!-- Timing -->
                <div id="preview-timing" style="text-align: left; font-size: 0.75rem; color: var(--text-muted); margin-top: 0.5rem;"></div>
            </div>

            <div class="card">
                <div style="display: flex; align-items: center; gap: 0.7rem; margin-bottom: 0.5rem;">
                    <h2 style="margin: 0;">×›×ª×‘ ×”×ª×‘×™×¢×”</h2>
                    <span id="generation-mode-badge" style="display:none; padding: 0.2rem 0.7rem; border-radius: 12px; font-size: 0.8rem; font-weight: bold;"></span>
                </div>
                <div class="claim-preview" id="claim-text-preview"></div>
            </div>

            <div class="btn-row">
                <button class="btn btn-outline" onclick="goToStep(4)">×—×–×¨×” ×œ×¢×¨×™×›×”</button>
                <button class="btn btn-accent" onclick="downloadDocx()">×”×•×¨×“ ×›×§×•×‘×¥ Word</button>
                <button class="btn btn-primary" onclick="copyClaimText()">×”×¢×ª×§ ×˜×§×¡×˜</button>
            </div>
        </div>
    </div>

</div>

<script>
    let currentStep = 0;
    let lastData = null;
    let lastResult = null;
    let lastAiResponse = null;
    let uploadedFiles = [];  // {name, type, data (base64)}

    // â”€â”€ Step 0 functions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function skipToManual() {
        document.getElementById('step0').classList.remove('active');
        document.getElementById('main-stepper').style.display = 'flex';
        goToStep(1);
    }

    function showUploadArea() {
        document.getElementById('upload-area').style.display = 'block';
    }

    function handleFiles(fileListObj) {
        const MAX_FILES = 5;
        const newFiles = Array.from(fileListObj);
        if (uploadedFiles.length + newFiles.length > MAX_FILES) {
            alert('× ×™×ª×Ÿ ×œ×”×¢×œ×•×ª ×¢×“ ' + MAX_FILES + ' ×§×‘×¦×™×');
            return;
        }
        for (const file of newFiles) {
            const reader = new FileReader();
            reader.onload = () => {
                const base64 = reader.result.split(',')[1];
                uploadedFiles.push({ name: file.name, type: file.type, data: base64 });
                renderFileList();
            };
            reader.readAsDataURL(file);
        }
    }

    function renderFileList() {
        const ul = document.getElementById('file-list');
        ul.innerHTML = '';
        uploadedFiles.forEach((f, i) => {
            const li = document.createElement('li');
            li.innerHTML = `${f.name} <span class="remove-file" onclick="removeFile(${i})">âœ•</span>`;
            ul.appendChild(li);
        });
        document.getElementById('analyze-btn-row').style.display = uploadedFiles.length > 0 ? 'flex' : 'none';
    }

    function removeFile(idx) {
        uploadedFiles.splice(idx, 1);
        renderFileList();
    }

    // Drag-and-drop support
    document.addEventListener('DOMContentLoaded', () => {
        const zone = document.getElementById('upload-zone');
        if (!zone) return;
        zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('dragover'); });
        zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
        zone.addEventListener('drop', e => {
            e.preventDefault();
            zone.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });
    });

    async function analyzeDocuments() {
        if (uploadedFiles.length === 0) { alert('×™×© ×œ×”×¢×œ×•×ª ×§×•×‘×¥ ××—×“ ×œ×¤×—×•×ª'); return; }
        document.getElementById('upload-loading').classList.add('active');
        document.getElementById('extraction-results').style.display = 'none';

        try {
            const resp = await fetch('/extract-documents', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ files: uploadedFiles }),
            });
            const result = await resp.json();
            document.getElementById('upload-loading').classList.remove('active');

            if (!result.success) {
                alert('×©×’×™××” ×‘× ×™×ª×•×—: ' + (result.error || '×©×’×™××” ×œ× ×™×“×•×¢×”'));
                return;
            }

            displayExtractedData(result.extracted);
        } catch (e) {
            document.getElementById('upload-loading').classList.remove('active');
            alert('×©×’×™××” ×‘×ª×§×©×•×¨×ª: ' + e.message);
        }
    }

    function displayExtractedData(data) {
        document.getElementById('ext_employee_name').value = data.employee_name || '';
        document.getElementById('ext_id_number').value = data.id_number || '';
        document.getElementById('ext_employer_name').value = data.employer_name || '';
        document.getElementById('ext_employer_id').value = data.employer_id || '';
        document.getElementById('ext_start_date').value = data.start_date || '';
        document.getElementById('ext_end_date').value = data.end_date || '';
        document.getElementById('ext_monthly_salary').value = data.monthly_salary || '';
        document.getElementById('ext_job_title').value = data.job_title || '';
        document.getElementById('ext_address').value = data.address || '';
        const facts = Array.isArray(data.key_facts) ? data.key_facts.join('\n') : (data.key_facts || '');
        document.getElementById('ext_key_facts').value = facts;
        document.getElementById('extraction-results').style.display = 'block';
    }

    function applyExtractedData() {
        const map = {
            ext_employee_name: 'plaintiff_name',
            ext_id_number: 'plaintiff_id',
            ext_employer_name: 'defendant_name',
            ext_employer_id: 'defendant_id',
            ext_start_date: 'start_date',
            ext_end_date: 'end_date',
            ext_monthly_salary: 'base_salary',
            ext_job_title: 'job_title',
            ext_address: 'plaintiff_address',
        };
        for (const [src, dst] of Object.entries(map)) {
            const val = document.getElementById(src).value;
            if (val) {
                const target = document.getElementById(dst);
                if (target) target.value = val;
            }
        }
        const facts = document.getElementById('ext_key_facts').value;
        if (facts) {
            const narrative = document.getElementById('narrative');
            if (narrative) narrative.value = facts;
        }
    }

    function confirmExtraction() {
        applyExtractedData();
        document.getElementById('step0').classList.remove('active');
        document.getElementById('main-stepper').style.display = 'flex';
        goToStep(1);
    }

    // â”€â”€ End Step 0 functions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function toggleGlobalOT() {
        const section = document.getElementById('global_ot_section');
        const arrow = document.getElementById('global_ot_arrow');
        if (section.style.display === 'none') {
            section.style.display = 'block';
            arrow.textContent = 'â–¼';
        } else {
            section.style.display = 'none';
            arrow.textContent = 'â—€';
        }
    }

    function goToStep(step) {
        // Ensure stepper is visible once we enter step 1+
        if (step >= 1) {
            document.getElementById('step0').classList.remove('active');
            document.getElementById('main-stepper').style.display = 'flex';
        }

        // Update visibility
        document.querySelectorAll('.section-panel').forEach(p => p.classList.remove('active'));
        document.getElementById('step' + step).classList.add('active');

        // Update stepper
        document.querySelectorAll('.step').forEach(s => {
            const sStep = parseInt(s.dataset.step);
            s.classList.remove('active', 'completed');
            if (sStep === step) s.classList.add('active');
            else if (sStep < step) s.classList.add('completed');
        });

        // Show relevant detail panels in step 4
        if (step === 4) {
            showRelevantDetails();
        }

        currentStep = step;
    }

    function toggleCheck(el) {
        const cb = el.querySelector('input[type="checkbox"]');
        cb.checked = !cb.checked;
        el.classList.toggle('checked', cb.checked);
    }

    function showRelevantDetails() {
        const claimMap = {
            'claim_severance': 'detail_severance',
            'claim_prior_notice': 'detail_prior_notice',
            'claim_unpaid_salary': 'detail_unpaid_salary',
            'claim_overtime': 'detail_overtime',
            'claim_pension': 'detail_pension',
            'claim_vacation': 'detail_vacation',
            'claim_holidays': 'detail_holidays',
            'claim_recuperation': 'detail_recuperation',
            'claim_salary_delay': 'detail_salary_delay',
            'claim_emotional': 'detail_emotional',
            'claim_deductions': 'detail_deductions',
        };

        for (const [cbId, detailId] of Object.entries(claimMap)) {
            const cb = document.getElementById(cbId);
            const detail = document.getElementById(detailId);
            if (detail) {
                detail.style.display = cb && cb.checked ? 'block' : 'none';
            }
        }
    }

    function collectData() {
        const fields = [
            'plaintiff_name', 'plaintiff_id', 'gender', 'birth_year', 'plaintiff_address',
            'defendant_name', 'defendant_id', 'defendant_type', 'defendant_owner', 'defendant_business', 'defendant_address',
            'start_date', 'end_date', 'job_title', 'termination_type',
            'work_days_per_week', 'hours_per_day',
            'base_salary', 'commissions', 'work_schedule',
            'claim_severance', 'claim_prior_notice', 'claim_unpaid_salary', 'claim_overtime',
            'claim_pension', 'claim_vacation', 'claim_holidays',
            'claim_recuperation', 'claim_salary_delay', 'claim_emotional',
            'claim_deductions', 'claim_documents',
            'severance_deposited', 'unpaid_salary_amount',
            'weekly_overtime_125', 'weekly_overtime_150',
            'hourly_wage', 'standard_daily_hours', 'actual_daily_hours', 'global_ot_hours',
            'pension_deposited',
            'vacation_days_paid', 'vacation_rate_paid',
            'holiday_days_paid', 'holiday_rate_paid',
            'recuperation_days_paid',
            'salary_delay_amount', 'emotional_amount', 'deduction_amount',
            'narrative', 'court_header', 'attorney_name', 'attorney_id',
            'firm_name', 'firm_address', 'firm_phone', 'firm_fax', 'firm_email',
        ];

        const data = {};
        for (const f of fields) {
            const el = document.getElementById(f);
            if (!el) continue;
            if (el.type === 'checkbox') {
                data[f] = el.checked;
            } else {
                data[f] = el.value;
            }
        }
        return data;
    }

    async function generateClaim() {
        const data = collectData();

        // Frontend validation
        const errors = [];
        if (!data.start_date) errors.push('×™×© ×œ×”×–×™×Ÿ ×ª××¨×™×š ×ª×—×™×œ×ª ×¢×‘×•×“×”');
        if (!data.end_date) errors.push('×™×© ×œ×”×–×™×Ÿ ×ª××¨×™×š ×¡×™×•× ×¢×‘×•×“×”');
        if (data.start_date && data.end_date && data.start_date >= data.end_date) {
            errors.push('×ª××¨×™×š ×¡×™×•× ×—×™×™×‘ ×œ×”×™×•×ª ×××•×—×¨ ××ª××¨×™×š ×”×ª×—×œ×”');
        }
        if (!data.base_salary && !data.commissions) {
            errors.push('×™×© ×œ×”×–×™×Ÿ ×œ×¤×—×•×ª ×©×›×¨ ×‘×¡×™×¡ ××• ×¢××œ×•×ª');
        }

        if (errors.length > 0) {
            alert(errors.join('\n'));
            return;
        }

        goToStep(5);
        document.getElementById('loading').classList.add('active');
        document.getElementById('results').style.display = 'none';

        lastData = data;

        try {
            const resp = await fetch('/calculate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data),
            });

            const contentType = resp.headers.get('content-type') || '';
            if (!contentType.includes('application/json')) {
                throw new Error('×”×©×¨×ª ×”×—×–×™×¨ ×ª×’×•×‘×” ×œ× ×ª×§×™× ×”. ×™×™×ª×›×Ÿ ×©×¤×’ ×ª×•×§×£ ×”×”×ª×—×‘×¨×•×ª â€” × ×¡×• ×œ×¨×¢× ×Ÿ ××ª ×”×“×£.');
            }

            const result = await resp.json();

            if (!result.success) {
                alert('×©×’×™××”: ' + result.error);
                document.getElementById('loading').classList.remove('active');
                goToStep(4);
                return;
            }

            lastResult = result;

            // Display duration
            const dur = result.calculations.duration;
            document.getElementById('duration-display').textContent =
                `×ª×§×•×¤×ª ×”×¢×¡×§×”: ${dur.total_months} ×—×•×“×©×™× (${dur.decimal_years} ×©× ×™×) | ×©×›×¨ ×§×•×‘×¢: ${result.calculations.determining_salary.toLocaleString()} â‚ª`;

            // Display total
            document.getElementById('total-amount').textContent =
                result.calculations.total.toLocaleString();

            // Display claims table
            const tbody = document.getElementById('results-tbody');
            tbody.innerHTML = '';
            for (const [key, claim] of Object.entries(result.calculations.claims)) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${claim.name}</td><td>${claim.amount.toLocaleString()} â‚ª</td>`;
                tbody.appendChild(tr);
            }
            const totalTr = document.createElement('tr');
            totalTr.className = 'total-row';
            totalTr.innerHTML = `<td>×¡×”"×›</td><td>${result.calculations.total.toLocaleString()} â‚ª</td>`;
            tbody.appendChild(totalTr);

            // Display claim text
            document.getElementById('claim-text-preview').textContent = result.claim_text;

            // Show mode badge (template mode)
            showModeBadge('template');
            showPreviewPanel(null);  // Hide AI preview for template mode

            lastAiResponse = null;

            document.getElementById('loading').classList.remove('active');
            document.getElementById('results').style.display = 'block';

        } catch (e) {
            document.getElementById('loading').classList.remove('active');
            alert('×©×’×™××” ×‘×ª×§×©×•×¨×ª ×¢× ×”×©×¨×ª: ' + e.message);
            goToStep(4);
        }
    }

    let _aiProgressTimer = null;

    function startAiProgress() {
        const progressEl = document.getElementById('ai-progress');
        const bar = document.getElementById('progress-bar');
        const timer = document.getElementById('progress-timer');
        const stages = document.querySelectorAll('.progress-stage');
        progressEl.style.display = 'block';
        bar.style.width = '0%';
        stages.forEach(s => { s.querySelector('.stage-icon').textContent = 'â³'; s.style.color = 'var(--text-muted)'; });

        const startTime = Date.now();
        const stageSchedule = [
            { at: 0, stage: 'calculating', pct: 5 },
            { at: 1000, stage: 'analyzing', pct: 15 },
            { at: 4000, stage: 'drafting', pct: 30 },
            { at: 25000, stage: 'verifying', pct: 80 },
        ];
        let lastStageIdx = -1;

        _aiProgressTimer = setInterval(() => {
            const elapsed = Date.now() - startTime;
            const secs = Math.floor(elapsed / 1000);
            timer.textContent = `${secs} ×©× ×™×•×ª`;

            // Advance stages based on typical timing
            for (let i = stageSchedule.length - 1; i >= 0; i--) {
                if (elapsed >= stageSchedule[i].at && i > lastStageIdx) {
                    lastStageIdx = i;
                    // Mark completed stages
                    for (let j = 0; j < i; j++) {
                        const el = document.querySelector(`.progress-stage[data-stage="${stageSchedule[j].stage}"]`);
                        if (el) { el.querySelector('.stage-icon').textContent = 'âœ“'; el.style.color = 'var(--success)'; }
                    }
                    // Mark current active
                    const cur = document.querySelector(`.progress-stage[data-stage="${stageSchedule[i].stage}"]`);
                    if (cur) { cur.querySelector('.stage-icon').textContent = 'âš™ï¸'; cur.style.color = 'var(--primary)'; cur.style.fontWeight = 'bold'; }
                    break;
                }
            }

            // Smooth progress bar (logarithmic approach to ~90%)
            const targetPct = Math.min(90, 5 + 85 * (1 - Math.exp(-elapsed / 30000)));
            bar.style.width = targetPct.toFixed(1) + '%';

            // Timeout warning
            if (secs >= 55) {
                timer.textContent = `${secs} ×©× ×™×•×ª â€” ×›××¢×˜ ××¡×™×™×...`;
                timer.style.color = 'var(--danger)';
            }
        }, 500);
    }

    function stopAiProgress(success) {
        if (_aiProgressTimer) { clearInterval(_aiProgressTimer); _aiProgressTimer = null; }
        const bar = document.getElementById('progress-bar');
        const stages = document.querySelectorAll('.progress-stage');
        if (success) {
            bar.style.width = '100%';
            stages.forEach(s => { s.querySelector('.stage-icon').textContent = 'âœ“'; s.style.color = 'var(--success)'; s.style.fontWeight = 'normal'; });
        }
    }

    function resetAiProgress() {
        stopAiProgress(false);
        document.getElementById('ai-progress').style.display = 'none';
        document.getElementById('progress-timer').style.color = 'var(--text-muted)';
    }

    async function generateClaimAI() {
        const data = collectData();
        const rawFacts = document.getElementById('raw_facts_input').value;

        // Frontend validation
        const errors = [];
        if (!data.start_date) errors.push('×™×© ×œ×”×–×™×Ÿ ×ª××¨×™×š ×ª×—×™×œ×ª ×¢×‘×•×“×”');
        if (!data.end_date) errors.push('×™×© ×œ×”×–×™×Ÿ ×ª××¨×™×š ×¡×™×•× ×¢×‘×•×“×”');
        if (data.start_date && data.end_date && data.start_date >= data.end_date) {
            errors.push('×ª××¨×™×š ×¡×™×•× ×—×™×™×‘ ×œ×”×™×•×ª ×××•×—×¨ ××ª××¨×™×š ×”×ª×—×œ×”');
        }
        if (!data.base_salary && !data.commissions) {
            errors.push('×™×© ×œ×”×–×™×Ÿ ×œ×¤×—×•×ª ×©×›×¨ ×‘×¡×™×¡ ××• ×¢××œ×•×ª');
        }
        if (!rawFacts || !rawFacts.trim()) {
            errors.push('×™×© ×œ×”×–×™×Ÿ ×¢×•×‘×“×•×ª ×’×•×œ××™×•×ª ×œ×¦×•×¨×š ×™×¦×™×¨×” ×‘×××¦×¢×•×ª AI');
        }

        if (errors.length > 0) {
            alert(errors.join('\n'));
            return;
        }

        goToStep(5);
        document.getElementById('loading').classList.add('active');
        document.getElementById('loading-text').textContent = '××™×™×¦×¨ ×›×ª×‘ ×ª×‘×™×¢×” ×‘×××¦×¢×•×ª AI...';
        document.getElementById('results').style.display = 'none';
        startAiProgress();

        data.raw_text = rawFacts;
        lastData = data;

        try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 180000);

            const resp = await fetch('/generate-ai', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data),
                signal: controller.signal,
            });
            clearTimeout(timeoutId);

            const contentType = resp.headers.get('content-type') || '';
            if (!contentType.includes('application/json')) {
                throw new Error('×”×©×¨×ª ×”×—×–×™×¨ ×ª×’×•×‘×” ×œ× ×ª×§×™× ×”. ×™×™×ª×›×Ÿ ×©×¤×’ ×ª×•×§×£ ×”×”×ª×—×‘×¨×•×ª â€” × ×¡×• ×œ×¨×¢× ×Ÿ ××ª ×”×“×£.');
            }

            const result = await resp.json();

            if (!result.success) {
                stopAiProgress(false);
                alert('×©×’×™××”: ' + result.error);
                resetAiProgress();
                document.getElementById('loading').classList.remove('active');
                document.getElementById('loading-text').textContent = '××—×©×‘ ×•××™×™×¦×¨ ××ª ×›×ª×‘ ×”×ª×‘×™×¢×”...';
                goToStep(4);
                return;
            }

            stopAiProgress(true);
            lastResult = result;
            lastAiResponse = result.ai_response;
            window.aiGeneratedText = result.ai_text || '';

            // Display duration
            const dur = result.calculations.duration;
            document.getElementById('duration-display').textContent =
                `×ª×§×•×¤×ª ×”×¢×¡×§×”: ${dur.total_months} ×—×•×“×©×™× (${dur.decimal_years} ×©× ×™×) | ×©×›×¨ ×§×•×‘×¢: ${result.calculations.determining_salary.toLocaleString()} â‚ª`;

            // Display total
            document.getElementById('total-amount').textContent =
                result.calculations.total.toLocaleString();

            // Display claims table
            const tbody = document.getElementById('results-tbody');
            tbody.innerHTML = '';
            for (const [key, claim] of Object.entries(result.calculations.claims)) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${claim.name}</td><td>${claim.amount.toLocaleString()} â‚ª</td>`;
                tbody.appendChild(tr);
            }
            const totalTr = document.createElement('tr');
            totalTr.className = 'total-row';
            totalTr.innerHTML = `<td>×¡×”"×›</td><td>${result.calculations.total.toLocaleString()} â‚ª</td>`;
            tbody.appendChild(totalTr);

            // Display claim text
            document.getElementById('claim-text-preview').textContent = result.claim_text;

            // Show mode badge and preview panel
            showModeBadge(result.mode);
            if (result.mode === 'ai' && result.preview) {
                showPreviewPanel(result.preview);
            } else {
                showPreviewPanel(null);
            }

            // Brief delay to show completed progress before switching
            setTimeout(() => {
                resetAiProgress();
                document.getElementById('loading').classList.remove('active');
                document.getElementById('loading-text').textContent = '××—×©×‘ ×•××™×™×¦×¨ ××ª ×›×ª×‘ ×”×ª×‘×™×¢×”...';
                document.getElementById('results').style.display = 'block';
            }, 600);

        } catch (e) {
            stopAiProgress(false);
            resetAiProgress();
            document.getElementById('loading').classList.remove('active');
            document.getElementById('loading-text').textContent = '××—×©×‘ ×•××™×™×¦×¨ ××ª ×›×ª×‘ ×”×ª×‘×™×¢×”...';
            if (e.name === 'AbortError') {
                alert('×—×¨×™×’×” ×××’×‘×œ×ª ×”×–××Ÿ (60 ×©× ×™×•×ª). × ×¡×• ×©×•×‘ ××• ×”×©×ª××©×• ×‘×ª×‘× ×™×ª.');
            } else {
                alert('×©×’×™××” ×‘×ª×§×©×•×¨×ª ×¢× ×”×©×¨×ª: ' + e.message);
            }
            goToStep(4);
        }
    }

    function showModeBadge(mode) {
        const badge = document.getElementById('generation-mode-badge');
        if (mode === 'ai') {
            badge.textContent = '× ×•×¦×¨ ×‘×××¦×¢×•×ª AI';
            badge.style.background = 'linear-gradient(135deg, #c6a04a, #d4af37)';
            badge.style.color = '#1a365d';
            badge.style.display = 'inline-block';
        } else if (mode === 'template') {
            badge.textContent = '×ª×‘× ×™×ª';
            badge.style.background = '#e2e8f0';
            badge.style.color = '#4a5568';
            badge.style.display = 'inline-block';
        } else {
            badge.style.display = 'none';
        }
    }

    function showPreviewPanel(preview) {
        const panel = document.getElementById('ai-preview-panel');
        if (!preview) {
            panel.style.display = 'none';
            return;
        }
        panel.style.display = 'block';

        // Sections list
        const sectionsUl = document.getElementById('preview-sections');
        sectionsUl.innerHTML = '';
        (preview.sections || []).forEach((s, i) => {
            const li = document.createElement('li');
            li.textContent = `${i + 1}. ${s}`;
            li.style.padding = '0.15rem 0';
            sectionsUl.appendChild(li);
        });

        // Appendices
        const appUl = document.getElementById('preview-appendices');
        appUl.innerHTML = '';
        if (preview.appendices && preview.appendices.length > 0) {
            preview.appendices.forEach((a, i) => {
                const li = document.createElement('li');
                li.textContent = `â—„ ${a}`;
                li.style.padding = '0.15rem 0';
                appUl.appendChild(li);
            });
        } else {
            appUl.innerHTML = '<li style="color: var(--text-muted);">×œ× ×–×•×”×• × ×¡×¤×—×™×</li>';
        }

        // Claims table with formulas
        const tbody = document.getElementById('preview-claims-tbody');
        tbody.innerHTML = '';
        (preview.claims || []).forEach(c => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${c.name}</td><td style="font-size:0.8rem;direction:rtl">${c.formula || '-'}</td><td>${c.amount.toLocaleString()} â‚ª</td>`;
            tbody.appendChild(tr);
        });
        const totalTr = document.createElement('tr');
        totalTr.className = 'total-row';
        totalTr.innerHTML = `<td>×¡×”"×›</td><td></td><td>${(preview.total || 0).toLocaleString()} â‚ª</td>`;
        tbody.appendChild(totalTr);

        document.getElementById('preview-total').textContent =
            `×¡×”"×› ×¡×›×•× ×”×ª×‘×™×¢×”: ${(preview.total || 0).toLocaleString()} â‚ª`;

        // Verification notes
        const verDiv = document.getElementById('preview-verification');
        const verList = document.getElementById('preview-verification-list');
        if (preview.verification_notes && preview.verification_notes.length > 0) {
            verDiv.style.display = 'block';
            verList.innerHTML = '';
            preview.verification_notes.forEach(n => {
                const li = document.createElement('li');
                li.textContent = n;
                verList.appendChild(li);
            });
        } else {
            verDiv.style.display = 'none';
        }

        // Timing
        const timing = preview.stage_timing || {};
        if (timing.total_seconds) {
            document.getElementById('preview-timing').textContent =
                `${timing.stages_completed || '?'} ×©×œ×‘×™× ×”×•×©×œ××• ×‘-${timing.total_seconds} ×©× ×™×•×ª`;
        }
    }

    async function downloadDocx() {
        if (!lastData) return;

        try {
            // Include AI text and response in the request if available
            const requestData = { ...lastData };
            if (window.aiGeneratedText) {
                requestData.ai_body_text = window.aiGeneratedText;
            }
            if (lastAiResponse) {
                requestData._ai_response = lastAiResponse;
            }

            const resp = await fetch('/generate-docx', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestData),
            });

            if (!resp.ok) {
                alert('×©×’×™××” ×‘×™×¦×™×¨×ª ×”×§×•×‘×¥');
                return;
            }

            const blob = await resp.blob();
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `×›×ª×‘_×ª×‘×™×¢×”_${lastData.plaintiff_name || 'claim'}.docx`;
            a.click();
            URL.revokeObjectURL(url);
        } catch (e) {
            alert('×©×’×™××”: ' + e.message);
        }
    }

    function copyClaimText() {
        const text = document.getElementById('claim-text-preview').textContent;
        navigator.clipboard.writeText(text).then(() => {
            alert('×”×˜×§×¡×˜ ×”×•×¢×ª×§ ×œ×œ×•×—!');
        });
    }

    // Initialize checkbox visual state
    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.checkbox-item input[type="checkbox"]').forEach(cb => {
            if (cb.checked) cb.closest('.checkbox-item').classList.add('checked');
        });
    });
</script>

<script>
    // PWA: Service Worker Registration & Install Prompt
    let deferredPrompt = null;

    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js').catch(() => {});
    }

    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        document.getElementById('install-btn').style.display = 'inline-block';
    });

    function installApp() {
        if (!deferredPrompt) return;
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((result) => {
            if (result.outcome === 'accepted') {
                document.getElementById('install-btn').style.display = 'none';
            }
            deferredPrompt = null;
        });
    }

    window.addEventListener('appinstalled', () => {
        document.getElementById('install-btn').style.display = 'none';
        deferredPrompt = null;
    });
</script>

</body>
</html>
